<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Word Pop Match - ‡πÄ‡∏Å‡∏°‡∏à‡∏±‡∏ö‡∏Ñ‡∏π‡πà‡∏Ñ‡∏≥‡∏®‡∏±‡∏û‡∏ó‡πå (TTS)</title>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;700;900&display=swap" rel="stylesheet">

    <style>
        /* --- CSS (‡∏Ñ‡∏á‡πÄ‡∏î‡∏¥‡∏°‡πÅ‡∏•‡∏∞‡∏à‡∏±‡∏î‡∏Å‡∏∂‡πà‡∏á‡∏Å‡∏•‡∏≤‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å) --- */
        :root {
            --color-primary: #9C27B0; 
            --color-secondary: #E1BEE7; 
            --color-correct: #00BCD4; 
            --color-wrong: #FF5252; 
            --color-bg: #F3E5F5; 
            --color-card: #FFFFFF; 
            --color-button-bg: #FCE4EC; 
            --color-text-dark: #333333;
            --color-text-light: #FFFFFF;
        }

        body {
            font-family: 'Sarabun', sans-serif;
            background-color: var(--color-bg);
            color: var(--color-text-dark);
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center; 
            min-height: 100vh;
            text-align: center;
        }

        .container {
            width: 100%;
            max-width: 500px; 
            box-sizing: border-box;
            background-color: var(--color-card);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            padding: 0;
        }

        header {
            background-color: var(--color-primary);
            color: var(--color-text-light);
            padding: 1.5rem 1rem;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15);
        }
        header h1 {
            font-size: 1.8rem;
            margin: 0;
        }

        .screen {
            padding: 1rem;
            display: none; 
            flex-grow: 1;
            flex-direction: column;
            justify-content: space-between;
        }
        .screen.active {
            display: flex;
        }

        /* --- Level Selection Screen --- */
        #level-select-screen .level-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            padding: 1rem 0;
        }
        .level-btn {
            background-color: #673AB7; 
            color: var(--color-text-light);
            border: none;
            padding: 1.5rem 0.5rem;
            border-radius: 12px;
            font-size: 1.4rem;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 4px 0 #5E35B1;
            transition: transform 0.1s, box-shadow 0.1s;
        }
        .level-btn-title {
            font-size: 0.8rem;
            font-weight: 400;
            display: block;
            margin-top: 5px;
        }

        /* --- Game Screen --- */
        #game-screen .status-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0;
            font-weight: bold;
            margin-bottom: 1rem;
            color: #4A148C; 
        }

        /* Prompt Area (Speaker Button & Word Text) */
        #prompt-area {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            margin-bottom: 1.5rem;
            min-height: 150px; 
        }
        #word-prompt-text {
            font-size: 2.5rem; 
            font-weight: 900;
            margin-bottom: 10px;
            color: var(--color-primary);
        }
        #audio-button {
            background-color: var(--color-primary); 
            border: none;
            border-radius: 50%;
            width: 100px; 
            height: 100px; 
            font-size: 3em; 
            cursor: pointer;
            box-shadow: 0 6px 0 #7B1FA2; 
            transition: transform 0.1s ease;
            color: var(--color-text-light); 
        }
        #audio-button:active {
            transform: translateY(3px); 
            box-shadow: 0 3px 0 #7B1FA2;
        }
        
        /* Choices Area (4-button Grid) */
        #options-area {
            /* ‡∏à‡∏±‡∏î‡∏Å‡∏∂‡πà‡∏á‡∏Å‡∏•‡∏≤‡∏á‡πÅ‡∏ô‡∏ß‡∏ô‡∏≠‡∏ô */
            display: grid;
            grid-template-columns: 1fr 1fr; 
            gap: 15px;
            flex-grow: 1; 
            padding-bottom: 1rem;
            max-width: 400px; 
            margin: 0 auto; /* ‡∏Å‡∏∂‡πà‡∏á‡∏Å‡∏•‡∏≤‡∏á‡πÉ‡∏ô‡πÅ‡∏ô‡∏ß‡∏ô‡∏≠‡∏ô */
            width: 100%; 
        }
        .option-btn {
            background-color: var(--color-button-bg);
            border: 5px solid var(--color-secondary); 
            border-radius: 15px; 
            padding: 10px;
            cursor: pointer;
            aspect-ratio: 1 / 1; 
            box-sizing: border-box;
            
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        .option-btn .item-icon {
            font-size: 3em; 
            margin-bottom: 5px;
        }
        .option-btn .item-word {
            font-size: 1.1em; 
            font-weight: bold;
            color: var(--color-text-dark);
        }

        .option-btn.correct {
            border-color: var(--color-correct) !important; 
            box-shadow: 0 0 20px #4DD0E1; 
            transform: scale(1.05);
            background-color: #E0F7FA; 
        }
        .option-btn.incorrect {
            border-color: var(--color-wrong) !important; 
            animation: shake 0.5s;
            background-color: #FFEBEE; 
        }

        /* Footer */
        #game-footer {
            margin-top: 1.5rem;
            padding-top: 1rem;
            border-top: 1px solid #ECEFF1;
            flex-shrink: 0; 
        }
        #next-btn {
            background-color: var(--color-primary);
            color: var(--color-text-light);
            border: none;
            width: 100%;
            padding: 1rem;
            border-radius: 50px;
            font-size: 1.2rem;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 4px 0 #7B1FA2;
        }
    </style>
</head>
<body>

    <div class="container">
        <header>
            <h1>Word Pop Match (TTS)</h1>
        </header>

        <div id="level-select-screen" class="screen active">
            <h2>üéâ ‡πÄ‡∏Å‡∏°‡∏à‡∏±‡∏ö‡∏Ñ‡∏π‡πà‡∏†‡∏≤‡∏û‡πÅ‡∏•‡∏∞‡πÄ‡∏™‡∏µ‡∏¢‡∏á</h2>
            <p>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏∏‡∏î‡∏Ñ‡∏≥‡∏®‡∏±‡∏û‡∏ó‡πå‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ù‡∏∂‡∏Å‡∏ù‡∏ô (Level ‡∏•‡∏∞ 10 ‡∏Ñ‡∏≥):</p>
            <div class="level-grid" id="level-grid">
                </div>
            <p style="padding-top: 2rem; color:#9E9E9E;">‡∏°‡∏µ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î 10 Levels x 10 ‡∏Ñ‡∏≥ = 100 ‡∏Ñ‡∏≥‡∏®‡∏±‡∏û‡∏ó‡πå</p>
        </div>

        <div id="game-screen" class="screen">
            <div class="top-content">
                <div class="status-bar">
                    <span id="level-title"></span>
                    <span id="q-count">‡∏Ç‡πâ‡∏≠: 0/10</span>
                    <span id="score">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô: 0</span>
                </div>

                <div id="prompt-area">
                    <div id="word-prompt-text"></div> 
                    <button id="audio-button" aria-label="Listen to the word">
                        <span class="speaker-icon">üîä</span>
                    </button>
                    <div id="feedback-message" style="margin-top:10px; font-weight:bold; color:var(--color-text-dark);"></div>
                </div>

                <div id="options-area">
                    </div>
            </div>

            <div id="game-footer">
                <button id="next-btn" disabled>‡∏Ç‡πâ‡∏≠‡∏ñ‡∏±‡∏î‡πÑ‡∏õ</button>
            </div>
        </div>
    </div>

    <script>
        /* ------------------- JavaScript Core Logic (‡πÉ‡∏ä‡πâ TTS) ------------------- */

        // --- DATA (‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ path ‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÅ‡∏•‡πâ‡∏ß) ---
        const ALL_LEVEL_WORDS = [
            // LEVEL 1: Colors & Basic Objects
            { level: 1, title: "‡∏™‡∏µ‡πÅ‡∏•‡∏∞‡∏™‡∏¥‡πà‡∏á‡∏Ç‡∏≠‡∏á‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô", questions: [
                { word: "red", icon: "üî¥" },
                { word: "blue", icon: "üîµ" },
                { word: "yellow", icon: "üü°" },
                { word: "green", icon: "üü¢" },
                { word: "sun", icon: "‚òÄÔ∏è" },
                { word: "star", icon: "‚≠ê" },
                { word: "moon", icon: "üåô" },
                { word: "cloud", icon: "‚òÅÔ∏è" },
                { word: "tree", icon: "üå≥" },
                { word: "flower", icon: "üå∏" },
            ]},
            // LEVEL 2: Animals 
            { level: 2, title: "‡∏™‡∏±‡∏ï‡∏ß‡πå", questions: [
                { word: "dog", icon: "üêï" },
                { word: "cat", icon: "üêà" },
                { word: "fish", icon: "üêü" },
                { word: "bird", icon: "üê¶" },
                { word: "lion", icon: "ü¶Å" },
                { word: "bear", icon: "üêª" },
                { word: "cow", icon: "üêÑ" },
                { word: "pig", icon: "üêñ" },
                { word: "frog", icon: "üê∏" },
                { word: "rabbit", icon: "üêá" },
            ]},
            // LEVEL 3: Fruits 
            { level: 3, title: "‡∏ú‡∏•‡πÑ‡∏°‡πâ", questions: [
                { word: "apple", icon: "üçé" },
                { word: "banana", icon: "üçå" },
                { word: "grape", icon: "üçá" },
                { word: "orange", icon: "üçä" },
                { word: "strawberry", icon: "üçì" },
                { word: "watermelon", icon: "üçâ" },
                { word: "kiwi", icon: "ü•ù" },
                { word: "cherry", icon: "üçí" },
                { word: "peach", icon: "üçë" },
                { word: "pear", icon: "üçê" },
            ]},
             // LEVEL 4: Body Parts
            { level: 4, title: "‡∏≠‡∏ß‡∏±‡∏¢‡∏ß‡∏∞", questions: [
                { word: "head", icon: "üßë" }, 
                { word: "eye", icon: "üëÅÔ∏è" },
                { word: "nose", icon: "üëÉ" },
                { word: "mouth", icon: "üëÑ" },
                { word: "ear", icon: "üëÇ" },
                { word: "hand", icon: "‚úã" },
                { word: "foot", icon: "ü¶∂" },
                { word: "arm", icon: "üí™" },
                { word: "leg", icon: "ü¶µ" },
                { word: "finger", icon: "üëÜ" },
            ]},
            // LEVEL 5: Vehicles
            { level: 5, title: "‡∏¢‡∏≤‡∏ô‡∏û‡∏≤‡∏´‡∏ô‡∏∞", questions: [
                { word: "car", icon: "üöó" },
                { word: "bus", icon: "üöå" },
                { word: "train", icon: "üöÇ" },
                { word: "bike", icon: "üö≤" },
                { word: "boat", icon: "‚õµ" },
                { word: "plane", icon: "‚úàÔ∏è" },
                { word: "truck", icon: "üöö" },
                { word: "scooter", icon: "üõ¥" },
                { word: "taxi", icon: "üöï" },
                { word: "ship", icon: "üö¢" },
            ]},
            // LEVEL 6: Clothes
            { level: 6, title: "‡πÄ‡∏™‡∏∑‡πâ‡∏≠‡∏ú‡πâ‡∏≤", questions: [
                { word: "shirt", icon: "üëï" },
                { word: "dress", icon: "üëó" },
                { word: "shoes", icon: "üëü" },
                { word: "hat", icon: "üß¢" },
                { word: "socks", icon: "üß¶" },
                { word: "pants", icon: "üëñ" },
                { word: "skirt", icon: "üëö" },
                { word: "coat", icon: "üß•" },
                { word: "scarf", icon: "üß£" },
                { word: "gloves", icon: "üß§" },
            ]},
            // LEVEL 7: Family
            { level: 7, title: "‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏£‡∏±‡∏ß", questions: [
                { word: "mother", icon: "üë©", },
                { word: "father", icon: "üë®" },
                { word: "sister", icon: "üëß" },
                { word: "brother", icon: "üë¶" },
                { word: "baby", icon: "üë∂" },
                { word: "grandma", icon: "üëµ" },
                { word: "grandpa", icon: "üë¥" },
                { word: "aunt", icon: "üßë‚Äçü¶±" },
                { word: "uncle", icon: "üßî" },
                { word: "friend", icon: "üßë‚Äçü§ù‚Äçüßë" },
            ]},
            // LEVEL 8: Food
            { level: 8, title: "‡∏≠‡∏≤‡∏´‡∏≤‡∏£", questions: [
                { word: "pizza", icon: "üçï" },
                { word: "bread", icon: "üçû" },
                { word: "milk", icon: "ü•õ" },
                { word: "egg", icon: "ü•ö" },
                { word: "cheese", icon: "üßÄ" },
                { word: "carrot", icon: "ü•ï" },
                { word: "soup", icon: "ü•£" },
                { word: "cake", icon: "üéÇ" },
                { word: "water", icon: "üíß" },
                { word: "cookie", icon: "üç™" },
            ]},
            // LEVEL 9: Actions
            { level: 9, title: "‡∏Å‡∏£‡∏¥‡∏¢‡∏≤", questions: [
                { word: "run", icon: "üèÉ" },
                { word: "jump", icon: "ü§∏" },
                { word: "sleep", icon: "üò¥" },
                { word: "eat", icon: "üçΩÔ∏è" },
                { word: "drink", icon: "ü•§" },
                { word: "read", icon: "üìñ" },
                { word: "sing", icon: "üé§" },
                { word: "walk", icon: "üö∂" },
                { word: "play", icon: "ü§π" },
                { word: "talk", icon: "üó£Ô∏è" },
            ]},
            // LEVEL 10: Adjectives
            { level: 10, title: "‡∏Ñ‡∏≥‡∏Ñ‡∏∏‡∏ì‡∏®‡∏±‡∏û‡∏ó‡πå", questions: [
                { word: "happy", icon: "üòÑ" },
                { word: "sad", icon: "üò•" },
                { word: "big", icon: "‚¨ÜÔ∏è" },
                { word: "small", icon: "‚¨áÔ∏è" },
                { word: "hot", icon: "üî•" },
                { word: "cold", icon: "ü•∂" },
                { word: "fast", icon: "üí®" },
                { word: "slow", icon: "üêå" },
                { word: "clean", icon: "üßº" },
                { word: "dirty", icon: "üí©" },
            ]},
        ];

        const OPTIONS_COUNT = 4;
        const MAX_REPLAY_COUNT = 3; 

        // --- ELEMENTS & TTS SETUP ---
        const levelSelectScreen = document.getElementById('level-select-screen');
        const gameScreen = document.getElementById('game-screen');
        const levelGridEl = document.getElementById('level-grid');
        const levelTitleEl = document.getElementById('level-title');
        const qCountEl = document.getElementById('q-count');
        const scoreEl = document.getElementById('score');
        const wordPromptTextEl = document.getElementById('word-prompt-text'); 
        const audioButton = document.getElementById('audio-button');
        const feedbackMessageEl = document.getElementById('feedback-message');
        const optionsArea = document.getElementById('options-area');
        const nextBtn = document.getElementById('next-btn');

        // TTS Variables
        const synth = window.speechSynthesis;
        let voice = null; 
        let isSpeaking = false;


        // --- GAME STATE ---
        let currentLevelData = null;
        let currentQuizIndex = 0; 
        let score = 0;
        let isAnswered = false;
        let currentWord = {};
        let audioPlayCount = 0; 

        // --- TTS FUNCTIONS ---

        function initTTS() {
            if (voice) return;

            const voices = synth.getVoices();
            voice = voices.find(v => v.lang === 'en-US' || v.lang.startsWith('en-')); 
            
            if (!voice && voices.length > 0) {
                 voice = voices[0];
            }
            if (!voice) {
                 console.error("No compatible voice found for TTS.");
            }
        }
        
        function speakWord(word) {
            if (!synth || !word || isSpeaking) return;
            
            synth.cancel(); 
            
            const utterance = new SpeechSynthesisUtterance(word);
            utterance.lang = 'en-US'; 
            utterance.rate = 0.9; 
            utterance.voice = voice;
            
            utterance.onstart = () => { isSpeaking = true; audioButton.disabled = true; };
            utterance.onend = () => { 
                isSpeaking = false; 
                if (!isAnswered && audioPlayCount < MAX_REPLAY_COUNT) {
                    audioButton.disabled = false;
                }
            };
            
            synth.speak(utterance);
        }

        function speakFeedback(message) {
            if (!synth || !message) return;
            
            synth.cancel();
            const utterance = new SpeechSynthesisUtterance(message);
            utterance.lang = 'en-US'; 
            utterance.rate = 1.0; 
            utterance.voice = voice;
            synth.speak(utterance);
        }
        
        // --- AUDIO CONTROL LOGIC (TTS) ---

        function tryAutoPlayTTS() {
            if (isAnswered) return;
            
            speakWord(currentWord.word);
            audioPlayCount = 1; 
            updateAudioButtonState();
        }
        
        function playWordAudioByUserClickTTS() {
            if (isAnswered || isSpeaking) return;
            
            if (audioPlayCount < MAX_REPLAY_COUNT) {
                speakWord(currentWord.word);
                audioPlayCount++;
                updateAudioButtonState();
            }
        }
        
        function updateAudioButtonState() {
            if (isAnswered || isSpeaking) {
                 audioButton.disabled = true;
                 return;
            }
            
            if (audioPlayCount >= MAX_REPLAY_COUNT) {
                audioButton.disabled = true;
                feedbackMessageEl.textContent = '‡∏´‡∏°‡∏î‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ü‡∏±‡∏á‡∏ã‡πâ‡∏≥‡πÅ‡∏•‡πâ‡∏ß';
                feedbackMessageEl.style.color = 'var(--color-wrong)';
            } else {
                audioButton.disabled = false;
                const remaining = MAX_REPLAY_COUNT - audioPlayCount;

                if (audioPlayCount === 0) {
                    feedbackMessageEl.textContent = `üîä ‡πÅ‡∏ï‡∏∞‡∏ó‡∏µ‡πà‡∏•‡∏≥‡πÇ‡∏û‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ü‡∏±‡∏á‡∏Ñ‡∏≥‡∏®‡∏±‡∏û‡∏ó‡πå (‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏≠‡∏µ‡∏Å ${MAX_REPLAY_COUNT} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á)`;
                } else if (remaining > 0) {
                    feedbackMessageEl.textContent = `üîä ‡∏ü‡∏±‡∏á‡∏ã‡πâ‡∏≥‡πÑ‡∏î‡πâ‡∏≠‡∏µ‡∏Å ${remaining} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á`;
                } else {
                    feedbackMessageEl.textContent = `üîä ‡∏ô‡∏µ‡πà‡∏Ñ‡∏∑‡∏≠‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢‡∏ó‡∏µ‡πà‡∏ü‡∏±‡∏á‡∏ã‡πâ‡∏≥‡πÑ‡∏î‡πâ!`;
                }
            }
        }


        // --- GAME LOGIC ---

        function createLevelButtons() {
            levelGridEl.innerHTML = '';
            // **‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡∏•‡∏ö initTTS() ‡∏≠‡∏≠‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏õ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏£‡∏ß‡∏î‡πÄ‡∏£‡πá‡∏ß**
            
            ALL_LEVEL_WORDS.forEach(data => {
                const btn = document.createElement('button');
                btn.className = 'level-btn';
                btn.textContent = `Level ${data.level}`;
                
                const titleSpan = document.createElement('span');
                titleSpan.className = 'level-btn-title';
                titleSpan.textContent = data.title;
                
                btn.appendChild(titleSpan);
                btn.setAttribute('data-level', data.level);
                
                btn.addEventListener('click', () => {
                    startLevel(data.level);
                });
                levelGridEl.appendChild(btn);
            });
        }

        function showScreen(id) {
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });
            document.getElementById(id).classList.add('active');
        }


        function updateStatusBar() {
            if (currentLevelData) {
                levelTitleEl.textContent = `${currentLevelData.title} (Level ${currentLevelData.level})`;
                qCountEl.textContent = `‡∏Ç‡πâ‡∏≠: ${currentQuizIndex + 1}/${currentLevelData.questions.length}`;
            }
            scoreEl.textContent = `‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô: ${score}`;
        }


        function startLevel(levelId) {
            currentLevelData = ALL_LEVEL_WORDS.find(data => data.level === levelId);
            currentQuizIndex = 0;
            score = 0; 
            // **‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠**
            showScreen('game-screen'); 
            nextQuestion();
        }

        function nextQuestion() {
            if (currentQuizIndex >= currentLevelData.questions.length) {
                endGame();
                return;
            }
            
            isAnswered = false;
            audioPlayCount = 0; 
            
            nextBtn.textContent = '‡∏Ç‡πâ‡∏≠‡∏ñ‡∏±‡∏î‡πÑ‡∏õ';
            nextBtn.disabled = true;
            feedbackMessageEl.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ñ‡∏≥‡∏®‡∏±‡∏û‡∏ó‡πå...';
            feedbackMessageEl.style.color = 'var(--color-text-dark)';

            optionsArea.innerHTML = ''; 
            wordPromptTextEl.textContent = ''; 
            
            updateStatusBar();
            setupQuestion();
        }

        function getGameOptions() {
            const currentLevelWords = currentLevelData.questions;
            const correctWord = currentLevelWords[currentQuizIndex]; 
            
            let options = [correctWord];
            const allWords = ALL_LEVEL_WORDS.flatMap(l => l.questions);
            const allWordsExcludingCorrect = allWords.filter(w => w.word !== correctWord.word);
            
            const shuffledDistractors = allWordsExcludingCorrect.sort(() => 0.5 - Math.random());
            const distractors = shuffledDistractors.slice(0, OPTIONS_COUNT - 1);
            
            options = [...options, ...distractors];

            while (options.length > OPTIONS_COUNT) {
                 options.pop();
            }
            
            options.sort(() => Math.random() - 0.5); 
            
            currentWord = correctWord;
            return options.slice(0, OPTIONS_COUNT);
        }


        function setupQuestion() {
            const options = getGameOptions();
            
            // 1. ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏õ‡∏∏‡πà‡∏°‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
            options.forEach(item => {
                const button = document.createElement('button');
                button.className = 'option-btn';
                button.dataset.word = item.word;
                button.dataset.isCorrect = item.word === currentWord.word;
                
                button.innerHTML = `
                    <span class="item-icon">${item.icon}</span>
                    <span class="item-word">${item.word.toUpperCase()}</span>
                `;
                button.addEventListener('click', handleAnswer);
                optionsArea.appendChild(button);
            });
            
            // 2. ‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏≥‡πÇ‡∏à‡∏ó‡∏¢‡πå (TEXT) 
            wordPromptTextEl.textContent = currentWord.word.toUpperCase();

            // 3. ‡∏•‡∏≠‡∏á‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ 
            tryAutoPlayTTS();
            
            // 4. ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô 
            updateAudioButtonState(); 
        }

        function handleAnswer(event) {
            if (isAnswered) return;
            isAnswered = true;
            
            const selectedButton = event.currentTarget;
            const isCorrect = selectedButton.dataset.isCorrect === 'true';

            synth.cancel(); 
            audioButton.disabled = true;

            // 1. Disable all choices
            document.querySelectorAll('.option-btn').forEach(btn => {
                btn.removeEventListener('click', handleAnswer);
                btn.disabled = true;
            });

            // 2. Feedback
            if (isCorrect) {
                score++;
                selectedButton.classList.add('correct');
                feedbackMessageEl.textContent = `‚úÖ ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á!`;
                feedbackMessageEl.style.color = 'var(--color-correct)';
                speakFeedback("Correct!");
            } else {
                selectedButton.classList.add('incorrect');
                feedbackMessageEl.textContent = `‚ùå ‡∏ú‡∏¥‡∏î! ‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏Ñ‡∏∑‡∏≠ ${currentWord.word.toUpperCase()}`;
                feedbackMessageEl.style.color = 'var(--color-wrong)';
                speakFeedback("Incorrect!");
                
                // Highlight the correct answer
                const correctAnswerButton = document.querySelector(`.option-btn[data-is-correct="true"]`);
                if (correctAnswerButton) {
                    correctAnswerButton.classList.add('correct');
                }
            }
            
            // 3. Update status and enable next button
            updateStatusBar();
            nextBtn.disabled = false;
        }


        function endGame() {
            levelTitleEl.textContent = `‡∏à‡∏ö Level ${currentLevelData.level}!`;
            qCountEl.textContent = '';
            
            const totalQuestions = currentLevelData.questions.length;
            feedbackMessageEl.innerHTML = `
                <span style="font-size:2rem; font-weight:900; color:var(--color-primary);">
                    ‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏≥‡πÑ‡∏î‡πâ ${score}/${totalQuestions} ‡∏Ç‡πâ‡∏≠
                </span>
            `;
            feedbackMessageEl.style.color = 'var(--color-primary)';
            
            optionsArea.innerHTML = ''; 
            wordPromptTextEl.textContent = '';

            nextBtn.textContent = '‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å';
            nextBtn.disabled = false;
        }

        // --- EVENT LISTENERS ---
        
        audioButton.addEventListener('click', () => {
             playWordAudioByUserClickTTS();
        });

        nextBtn.addEventListener('click', () => {
            synth.cancel(); 
            if (currentQuizIndex >= currentLevelData.questions.length - 1 && nextBtn.textContent === '‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å') { 
                showScreen('level-select-screen');
                currentQuizIndex = 0; 
                return;
            }
            
            currentQuizIndex++;
            nextQuestion();
            
        });


        // --- INITIAL SETUP ---
        document.addEventListener('DOMContentLoaded', () => {
            createLevelButtons();
            showScreen('level-select-screen');
            
            // ‡πÇ‡∏´‡∏•‡∏î TTS Voice ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏û‡∏£‡πâ‡∏≠‡∏° (‡∏ß‡∏¥‡∏ò‡∏µ‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô)
            if (synth && synth.onvoiceschanged !== undefined) {
                synth.onvoiceschanged = initTTS;
            } else if (synth) {
                // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏°‡∏µ onvoiceschanged
                initTTS();
            }
        });
    </script>
</body>
</html>
